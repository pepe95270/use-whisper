import { a } from './chunk-5RHHUFUE.js';
import { d } from './chunk-X4QJNRK4.js';
import { useEffectAsync, useMemoAsync } from '@chengsokdara/react-hooks-async';
import { useRef, useState, useEffect, useMemo } from 'react';

var Y={apiKey:"",autoStart:!1,autoTranscribe:!0,mode:"transcriptions",nonStop:!1,removeSilence:!1,stopTimeout:5e3,streaming:!1,concatChunk:!1,timeSlice:1e3,onDataAvailable:void 0,onTranscribeWhenSilent:void 0,onTranscribe:void 0,onStreamTranscribe:void 0,showLogs:!1,silenceBufferThreshold:255},de={stop:void 0},me={blob:void 0,text:void 0},ye=Z=>{let{apiKey:y,autoStart:H,autoTranscribe:F,mode:x,nonStop:D,removeSilence:B,stopTimeout:ee,streaming:_,concatChunk:re,timeSlice:M,whisperConfig:f,onTranscribeWhenSilent:S,onDataAvailable:te,onTranscribe:C,onStreamTranscribe:L,onRecord:P,showLogs:g,silenceBufferThreshold:W}={...Y,...Z};if(!y&&!C)throw new Error("apiKey is required if onTranscribe is not provided");let d$1=useRef([]),u=useRef([]),i=useRef(),c=useRef(),n=useRef(),a$1=useRef(),b=useRef(de),[q,A]=useState(!1),[K,U]=useState(!1),[O,T]=useState(!1),[I,l]=useState(me);useEffect(()=>()=>{d$1.current&&(d$1.current=[]),u.current&&(u.current=[]),i.current&&(i.current.flush(),i.current=void 0),n.current&&(n.current.destroy(),n.current=void 0),k("stop"),c.current&&(c.current.off("speaking",E),c.current.off("stopped_speaking",v)),a$1.current&&(a$1.current.getTracks().forEach(e=>e.stop()),a$1.current=void 0);},[]),useEffectAsync(async()=>{H&&await G();},[H]);let $=async()=>{await G();},j=async()=>{await oe();},z=async()=>{await N();},G=async()=>{try{if(a$1.current||await ne(),a$1.current){if(!n.current){let{default:{RecordRTCPromisesHandler:r,MediaStreamRecorder:t}}=await import('recordrtc'),o={mimeType:"audio/wav",numberOfAudioChannels:1,recorderType:t,sampleRate:44100,timeSlice:M,type:"audio",ondataavailable:ce,disableLogs:!g};n.current=new r(a$1.current,o);}if(!i.current){let{Mp3Encoder:r}=await import('lamejs');i.current=new r(1,44100,256);}let e=await n.current.getState();(e==="inactive"||e==="stopped")&&await n.current.startRecording(),e==="paused"&&await n.current.resumeRecording(),D&&J("stop"),A(!0);}}catch{}},ne=async()=>{try{if(a$1.current&&a$1.current.getTracks().forEach(e=>e.stop()),a$1.current=await navigator.mediaDevices.getUserMedia({audio:!0}),!c.current){let{default:e}=await import('hark');c.current=e(a$1.current,{interval:100,play:!1}),c.current.on("speaking",E),c.current.on("stopped_speaking",v);}}catch{}},J=e=>{b.current[e]||(b.current[e]=setTimeout(N,ee));},E=()=>{U(!0),k("stop");},v=()=>{U(!1),D&&J("stop");},oe=async()=>{try{n.current&&(await n.current.getState()==="recording"&&await n.current.pauseRecording(),k("stop"),A(!1));}catch{}},N=async()=>{try{if(n.current){let e=await n.current.getState();if((e==="recording"||e==="paused")&&await n.current.stopRecording(),ae(),k("stop"),A(!1),F)await ie();else {let r=await n.current.getBlob();l({blob:r});}if(typeof P=="function"&&i.current){let r=await n.current.getBlob(),t=await r.arrayBuffer(),o=await a({showLogs:g,blob:r,threshold:W||255,removeSilence:B});o||(t=null),P(o||r,t);}await n.current.destroy(),d$1.current=[],u.current=[],i.current&&(i.current.flush(),i.current=void 0),n.current=void 0;}}catch{}},ae=()=>{c.current&&(U(!1),c.current.off("speaking",E),c.current.off("stopped_speaking",v),c.current=void 0),a$1.current&&(a$1.current.getTracks().forEach(e=>e.stop()),a$1.current=void 0);},k=e=>{b.current[e]&&(clearTimeout(b.current[e]),b.current[e]=void 0);},ie=async()=>{if(typeof S=="function")try{let e;if(u.current.length>0){let t=u.current;u.current=[],e=new Blob(t,{type:"audio/mpeg"});}let r=await S(e,!0);r.text&&l(t=>({...t,text:t.text?t.text+r.text:r.text}));}catch{}try{if(i.current&&n.current&&await n.current.getState()==="stopped"){T(!0);let r=await n.current.getBlob(),t=await a({showLogs:g,blob:r,threshold:W||255,removeSilence:B});if(!t){l({blob:r}),T(!1);return}if(typeof C=="function"){let o=await C(r);l(o);}else {let o=new File([t],"speech.mp3",{type:"audio/mpeg"}),s=await Q(o);l({blob:t,text:s});}T(!1);}}catch{T(!1);}},ce=async e=>{if(typeof S=="function"){let r=await a({showLogs:g,blob:e,threshold:M||Y.timeSlice});if(r)u.current.push(r);else if(u.current.length>0){let t=u.current;u.current=[];let o=new Blob(t,{type:"audio/mpeg"}),s=await S(o);s.text&&l(m=>({...m,text:m.text?m.text+s.text:s.text}));}}if(F&&_)try{if(_&&n.current){if(te?.(e),i.current){let t=await e.arrayBuffer(),o=i.current.encodeBuffer(new Int16Array(t)),s=new Blob([o],{type:"audio/mpeg"});re?d$1.current.push(s):d$1.current=[s];}if(await n.current.getState()==="recording"){let t=new Blob(d$1.current,{type:"audio/mpeg"}),o=await a({showLogs:g,blob:t,threshold:W||255,removeSilence:B});if(!o)return;if(typeof L=="function")L(o);else {let s=new File([o],"speech.mp3",{type:"audio/mpeg"}),m=await Q(s);m&&l(se=>({...se,text:m}));}}}}catch{}},Q=useMemoAsync(async e=>{let r=new FormData;r.append("file",e),r.append("model","whisper-1"),x==="transcriptions"&&r.append("language",f?.language??"en"),f?.prompt&&r.append("prompt",f.prompt),f?.response_format&&r.append("response_format",f.response_format),f?.temperature&&r.append("temperature",`${f.temperature}`);let t={};t["Content-Type"]="multipart/form-data",y&&(t.Authorization=`Bearer ${y}`);let{default:o}=await import('axios');return (await o.post(d+x,r,{headers:t})).data.text},[y,x,f]);return useMemo(()=>({recording:q,speaking:K,transcribing:O,transcript:I,pauseRecording:j,startRecording:$,stopRecording:z}),[q,K,O,I,j,$,z])};

export { ye as a };
